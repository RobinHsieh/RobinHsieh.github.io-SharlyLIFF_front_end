<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>雲端小助手</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- 引入外部 CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>My DynamoDB Item List</h1>
  <ul id="item-list"></ul>

  <script>
    // 1. 初始化 LIFF
    async function initLiff() {
      try {
        await liff.init({ liffId: "2006838266-YvLRJn6m" });
        console.log("LIFF init done");
        // 抓取資料
        items = fetchItems()
        // 產生表格
        renderTable(items);
      } catch (err) {
        console.error("LIFF init error", err);
      }
    }

    // 2. 抓取 DynamoDB 資料，返回資料
    async function fetchItems() {
      try {
        const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
        const items = await response.json();
        console.log("Fetch items done");
        return items;
      } catch (err) {
        console.error("Fetch items error", err);
      }
    }

    // 將資料依照 WEEK_DAY & BATCH 做排序
    // WEEK_DAY 先轉成數字排序 (由小到大)
    // BATCH 假設格式為 "L + 數字"，可擷取數字做數值排序
    function sortData(data) {
      return data.sort((a, b) => {
        // 先比對 WEEK_DAY
        const dayA = parseInt(a.WEEK_DAY, 10);
        const dayB = parseInt(b.WEEK_DAY, 10);
        if (dayA !== dayB) {
          return dayA - dayB;
        } else {
          // WEEK_DAY 相同時，比較 BATCH
          // 假設 BATCH 格式為 "L0", "L1", "L2"...
          const numA = parseInt(a.BATCH.replace('L', ''), 10);
          const numB = parseInt(b.BATCH.replace('L', ''), 10);
          return numA - numB;
        }
      });
    }

    // 動態產生表格內容
    function renderTable(data) {
      const sortedData = sortData(data);
      const tbody = document.querySelector("#schedule-table tbody");
      tbody.innerHTML = ""; // 清空

      sortedData.forEach(item => {
        const tr = document.createElement("tr");
        
        // 星期(WEEK_DAY)
        const tdWeekDay = document.createElement("td");
        tdWeekDay.textContent = item.WEEK_DAY;
        tr.appendChild(tdWeekDay);

        // 梯次(BATCH)
        const tdBatch = document.createElement("td");
        tdBatch.textContent = item.BATCH;
        tr.appendChild(tdBatch);

        // 實體課號(PK)
        const tdPk = document.createElement("td");
        tdPk.textContent = item.PK;
        tr.appendChild(tdPk);

        // 狀態(IS_OPEN)
        const tdStatus = document.createElement("td");
        tdStatus.textContent = item.IS_OPEN ? "開啟" : "關閉";
        tr.appendChild(tdStatus);

        // 操作(兩個按鈕)
        const tdActions = document.createElement("td");

        // 「更改狀態」按鈕
        const btnToggle = document.createElement("button");
        btnToggle.textContent = "更改狀態";
        btnToggle.addEventListener("click", () => {
          if (item.IS_OPEN) {
            // IS_OPEN = true -> 傳送 "梯次狀態 關閉 {PK}"
            sendLiffMessage(`梯次狀態 關閉 ${item.PK}`);
          } else {
            // IS_OPEN = false -> 傳送 "梯次狀態 開啟 {PK}"
            sendLiffMessage(`梯次狀態 開啟 ${item.PK}`);
          }
        });
        tdActions.appendChild(btnToggle);

        // 「梯次刷新」按鈕
        const btnRefresh = document.createElement("button");
        btnRefresh.textContent = "梯次刷新";
        btnRefresh.addEventListener("click", () => {
          // 傳送 "梯次刷新 {PK}"
          sendLiffMessage(`梯次刷新 ${item.PK}`);
        });
        tdActions.appendChild(btnRefresh);

        tr.appendChild(tdActions);

        // 加到表格
        tbody.appendChild(tr);
      });
    }

    // 呼叫 liff.sendMessages() 傳送文字訊息
    async function sendLiffMessage(messageText) {
      try {
        await liff.sendMessages([
          {
            type: 'text',
            text: messageText
          }
        ]);
        alert(`已傳送訊息：${messageText}`);
      } catch (err) {
        console.error("sendMessages error", err);
        alert("傳送訊息失敗，請確認在 LINE in-app browser 中開啟此頁");
      }
    }

    window.onload = initLiff;
  </script>
</body>
</html>
