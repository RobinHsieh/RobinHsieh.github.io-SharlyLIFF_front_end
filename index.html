<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>My LIFF Page</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>My DynamoDB Item List</h1>
  <ul id="item-list"></ul>

  <script>
    // 1. 初始化 LIFF
    async function initLiff() {
      try {
        await liff.init({ liffId: "2006838266-YvLRJn6m" });
        console.log("LIFF init done");
        // 載入成功後，就去抓資料
        fetchItems();
      } catch (err) {
        console.error("LIFF init error", err);
      }
    }

    // 2. 抓取 DynamoDB 資料
    async function fetchItems() {
      try {
        const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
        const items = await response.json();
        renderItemList(items);
      } catch (err) {
        console.error("Fetch items error", err);
      }
    }

    // 3. 顯示資料清單 + 動態產生按鈕
    function renderItemList(items) {
      const ul = document.getElementById("item-list");
      ul.innerHTML = ""; // 清空

      items.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `[ID: ${item.id}] isEnabled = ${item.isEnabled}`;

        // 建立一個按鈕，點擊後送出指令
        const btn = document.createElement("button");
        btn.textContent = "Toggle";
        btn.addEventListener("click", () => {
          sendToggleCommand(item.id);
        });

        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    // 4. 送文字訊息到聊天室
    async function sendToggleCommand(itemId) {
      try {
        // 依照你後端預期的文字格式來組字串
        const commandText = `toggle ${itemId}`; 
        await liff.sendMessages([
          {
            type: 'text',
            text: commandText
          }
        ]);
        alert('已發送指令到聊天室！');
      } catch (err) {
        console.error("sendMessages error", err);
      }
    }

    // 執行 init
    initLiff();
  </script>
</body>
</html>
