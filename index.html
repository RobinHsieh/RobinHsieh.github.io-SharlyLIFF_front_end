<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>雲端小助手</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <!-- 引入外部 CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>管理頁面</h1>
      <a href="#" id="help-link">ⓘ 操作講解</a>
    </div>
    <div id="schedule-list">
      <!-- JavaScript 會在這裡動態插入卡片 -->
    </div>
  </div>

  <script>
    let items = [];  // 存放課程資料（目前的 UI 狀態）

    async function initLiff() {
      try {
        await liff.init({ liffId: "2006838266-YvLRJn6m" });
        console.log("LIFF init done");

        // 綁定「操作講解」連結
        document.getElementById("help-link").addEventListener("click", openHelpPage);
      } catch (err) {
        console.error("LIFF init error", err);
      }

      // **先顯示目前的 items**
      renderList(items);

      // **後台同步抓取最新資料**
      syncData();
    }

    async function syncData() {
      const newData = await fetchItems();
      updateList(newData);
    }

    async function fetchItems() {
      try {
        const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
        const data = await response.json();
        console.log("Fetch items done");
        return data;
      } catch (err) {
        console.error("Fetch items error", err);
        return []; // 避免報錯
      }
    }

    function sortData(data) {
      return data.sort((a, b) => {
        const dayA = parseInt(a.WEEK_DAY, 10);
        const dayB = parseInt(b.WEEK_DAY, 10);
        if (dayA !== dayB) {
          return dayA - dayB;
        } else {
          const numA = parseInt(a.BATCH.replace('L', ''), 10);
          const numB = parseInt(b.BATCH.replace('L', ''), 10);
          return numA - numB;
        }
      });
    }

    function renderList(data) {
      const sortedData = sortData(data);
      const listContainer = document.getElementById("schedule-list");

      sortedData.forEach((item, index) => {
        if (!document.getElementById(`card-${item.PK}`)) {
          const card = document.createElement("div");
          card.classList.add("card");
          card.id = `card-${item.PK}`;

          card.innerHTML = `
            <div class="card-header">
              <span class="week-day">星期 ${item.WEEK_DAY}</span>
              <span class="batch">梯次 ${item.BATCH}</span>
            </div>
            <div class="card-body">
              <p>課號: <strong>${item.PK}</strong></p>
              <p>狀態: <span id="status-${item.PK}" class="${item.IS_OPEN ? 'open' : 'closed'}">${item.IS_OPEN ? "開啟" : "關閉"}</span></p>
              <div class="button-group">
                <button id="toggle-btn-${item.PK}" class="toggle-btn">${item.IS_OPEN ? "關閉梯次" : "開啟梯次"}</button>
                <button class="refresh-btn" onclick="sendLiffMessage('梯次刷新 ${item.PK}')">梯次刷新</button>
              </div>
            </div>
          `;

          // 設定「更改狀態」按鈕
          const toggleBtn = card.querySelector(`#toggle-btn-${item.PK}`);
          toggleBtn.addEventListener("click", () => {
            toggleStatus(item.PK);
          });

          listContainer.appendChild(card);
        }
      });
    }

    function updateList(newData) {
      const newItemsMap = new Map(newData.map(item => [item.PK, item]));

      newItemsMap.forEach((newItem, pk) => {
        const oldItem = items.find(i => i.PK === pk);
        
        if (!oldItem) {
          // **新資料，直接新增**
          renderList([newItem]);
        } else if (oldItem.IS_OPEN !== newItem.IS_OPEN) {
          // **已有資料但狀態改變，更新 UI**
          document.getElementById(`status-${pk}`).textContent = newItem.IS_OPEN ? "開啟" : "關閉";
          document.getElementById(`status-${pk}`).className = newItem.IS_OPEN ? "open" : "closed";
          document.getElementById(`toggle-btn-${pk}`).textContent = newItem.IS_OPEN ? "關閉梯次" : "開啟梯次";
        }
      });

      // **更新本地 items**
      items = newData;
    }

    function toggleStatus(pk) {
      const item = items.find(i => i.PK === pk);
      if (!item) return;

      // **立即更新 UI**
      item.IS_OPEN = !item.IS_OPEN;
      document.getElementById(`status-${pk}`).textContent = item.IS_OPEN ? "開啟" : "關閉";
      document.getElementById(`status-${pk}`).className = item.IS_OPEN ? "open" : "closed";
      document.getElementById(`toggle-btn-${pk}`).textContent = item.IS_OPEN ? "關閉梯次" : "開啟梯次";

      // **發送 LINE 訊息**
      sendLiffMessage(`梯次狀態 ${item.IS_OPEN ? "開啟" : "關閉"} ${pk}`);
    }

    async function sendLiffMessage(messageText) {
      try {
        await liff.sendMessages([{ type: 'text', text: messageText }]);
      } catch (err) {
        console.error("sendMessages error", err);
        alert("傳送失敗，請確認在 LINE in-app browser 開啟");
      }
    }

    function openHelpPage() {
      const helpUrl = "https://robinhsieh.github.io/SharlyLIFF-front-end/help.html"; // 你的 help.html 的 Endpoint URL
      const encodedUrl = encodeURIComponent(helpUrl); // URL 編碼
      const liffId = "2006838266-YvLRJn6m"; // 你的 LIFF ID
      const liffUrl = `line://app/${liffId}?redirectUri=${encodedUrl}`;

      // 開啟「操作講解」的 LIFF 頁面
      liff.openWindow({
        url: liffUrl, // 設定「操作講解」的 LIFF 頁面 URL
        external: false  // **設定為 false，確保在 LIFF 瀏覽器內打開**
      });
    }

    window.onload = initLiff;
  </script>
</body>
</html>
