<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>雲端小助手</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <!-- 引入外部 CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- 📌 index 主視圖 -->
  <div id="studentOverview-view" class="view">
    <div class="container">
      <div class="header">
        <h2>請假狀況</h2>
        <a href="#" id="help-link">ⓘ 操作講解</a>
      </div>
      <div id="schedule-list">
        <!-- JavaScript 會在這裡動態插入卡片 -->
      </div>
    </div>
  </div>

  <!-- 📌 help 操作講解視圖（預設隱藏） -->
  <div id="help-view" class="view" style="display: none;">
    <div class="container">
      <div class="header">
        <h2>🚀 操作講解</h2>
        <a href="#" id="back-link">返回</a>
      </div>
      
      <h2>1️⃣ 梯次刷新</h2>
      <h3>👉 同步 Google Drive 資料夾，確保課程列表為最新版本：</h3>
      <ul>
          <li>📂 <strong>讀取</strong> 你指定的梯次對應的 Google Drive 資料夾。</li>
          <li>🔍 <strong>比對</strong> 現有資料，看看是否需要 <strong>加入、刪除或更新</strong> 課堂。</li>
          <li>🔄 <strong>更新</strong> 資料庫，確保 <strong>檔案ID 和名稱都是最新的</strong>。</li>
      </ul>

      <h3>🔹 怎麼操作？</h3>
      <ul>
          <li>點擊 <strong>「梯次刷新」</strong> 按鈕。</li>
          <li>系統會進行同步，並回報「新增/修改/刪除」的內容。</li>
      </ul>

      <div class="tip">
          ⚠️ <strong>小提醒</strong>：
          <ul>
              <li>如果梯次內 <strong>沒有變動</strong>，系統會回報「無需更新」。</li>
              <li>如果某個梯次 <strong>還沒建立</strong>，系統會回報「數據缺失」。</li>
          </ul>
      </div>

      <h2>2️⃣ 梯次狀態</h2>
      <h3>👉 <strong>開啟或關閉</strong> 某個梯次的課後雲端：</h3>
      <ul>
          <li>✅ <strong>開啟</strong>：學生可以申請觀看課程。</li>
          <li>🚫 <strong>關閉</strong>：暫停該梯次的影片共享，無法申請觀看。</li>
      </ul>

      <h3>🔹 怎麼操作？</h3>
      <ul>
          <li>選擇 <strong>「開啟梯次」</strong> 或 <strong>「關閉梯次」</strong> 按鈕。</li>
          <li>系統會變更該梯次的狀態，並顯示結果。</li>
      </ul>
    </div>
  </div>

  <script>
    let items = [];  // 存放課程資料（目前的 UI 狀態）
    const liffId = "2006838266-YvLRJn6m";

    async function initLiff() {
      try {
        await liff.init({ liffId: liffId });
        console.log("LIFF init done");

        document.getElementById("help-link").addEventListener("click", showHelpView);
        document.getElementById("back-link").addEventListener("click", showIndexView);        
      } catch (err) {
        console.error("LIFF init error", err);
      }

      // **先顯示目前的 items**
      renderList(items);

      // **後台同步抓取最新資料**
      syncData();
    }

    async function syncData() {
      const newData = await fetchItems();
      updateList(newData);
    }

    async function fetchItems() {
      try {
        const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
        const data = await response.json();
        console.log("Fetch items done");
        return data;
      } catch (err) {
        console.error("Fetch items error", err);
        return []; // 避免報錯
      }
    }

    function sortData(data) {
      return data.sort((a, b) => {
        const dayA = parseInt(a.WEEK_DAY, 10);
        const dayB = parseInt(b.WEEK_DAY, 10);
        if (dayA !== dayB) {
          return dayA - dayB;
        } else {
          const numA = parseInt(a.BATCH.replace('L', ''), 10);
          const numB = parseInt(b.BATCH.replace('L', ''), 10);
          return numA - numB;
        }
      });
    }

    function renderList(data) {
      const sortedData = sortData(data);
      const listContainer = document.getElementById("schedule-list");

      sortedData.forEach((item, index) => {
        if (!document.getElementById(`card-${item.PK}`)) {
          const card = document.createElement("div");
          card.classList.add("card");
          card.id = `card-${item.PK}`;

          card.innerHTML = `
            <div class="card-header">
              <span class="week-day">星期 ${item.WEEK_DAY}</span>
              <span class="batch">梯次 ${item.BATCH}</span>
            </div>
            <div class="card-body">
              <p>課號: <strong>${item.PK}</strong></p>
              <p>狀態: <span id="status-${item.PK}" class="${item.IS_OPEN ? 'open' : 'closed'}">${item.IS_OPEN ? "開啟" : "關閉"}</span></p>
              <div class="button-group">
                <button class="leave-btn" onclick="sendLiffMessage('請假顯示 ${item.PK}')">請假顯示</button>
                <button class="late-btn" onclick="sendLiffMessage('晚到顯示 ${item.PK}')">晚到顯示</button>
                <button class="recital-btn" onclick="sendLiffMessage('背書顯示 ${item.PK}')">背書顯示</button>
              </div>
            </div>
          `;

        //   // 設定「更改狀態」按鈕
        //   const toggleBtn = card.querySelector(`#toggle-btn-${item.PK}`);
        //   toggleBtn.addEventListener("click", () => {
        //     toggleStatus(item.PK);
        //   });

          listContainer.appendChild(card);
        }
      });
    }

    function updateList(newData) {
      // 用 Map 快取 newData，key 為 PK
      const newItemsMap = new Map(newData.map(item => [item.PK, item]));

      // 與本地 items 做比較
      newItemsMap.forEach((newItem, pk) => {
        const oldItem = items.find(i => i.PK === pk);
        
        if (!oldItem) {
          // 新課程 -> 新增卡片
          renderList([newItem]);
        } else if (oldItem.IS_OPEN !== newItem.IS_OPEN) {
          // 狀態改變 -> 局部更新該卡片 UI
          document.getElementById(`status-${pk}`).textContent = newItem.IS_OPEN ? "開啟" : "關閉";
          document.getElementById(`status-${pk}`).className = newItem.IS_OPEN ? "open" : "closed";
        //   document.getElementById(`toggle-btn-${pk}`).textContent = newItem.IS_OPEN ? "關閉梯次" : "開啟梯次";
        }
      });

      // 更新本地 items
      items = newData;

      // **在此呼叫重排函式**，確保 DOM 卡片順序正確
      reorderDomElements();
    }

    function reorderDomElements() {
      // 1. 排序當前 items
      const sortedData = sortData(items);

      // 2. 依照排序結果逐一把對應卡片 append 到最末端
      const listContainer = document.getElementById("schedule-list");

      sortedData.forEach(item => {
        const card = document.getElementById(`card-${item.PK}`);
        // 如果卡片存在，就把它重新 append 一次
        if (card) {
          listContainer.appendChild(card);
          // 這行會把 card 移到容器最後，形成最終的正確順序
        }
      });
    }

    // function toggleStatus(pk) {
    //   const item = items.find(i => i.PK === pk);
    //   if (!item) return;

    //   // **立即更新 UI**
    //   item.IS_OPEN = !item.IS_OPEN;
    //   document.getElementById(`status-${pk}`).textContent = item.IS_OPEN ? "開啟" : "關閉";
    //   document.getElementById(`status-${pk}`).className = item.IS_OPEN ? "open" : "closed";
    //   document.getElementById(`toggle-btn-${pk}`).textContent = item.IS_OPEN ? "關閉梯次" : "開啟梯次";

    //   // **發送 LINE 訊息**
    //   sendLiffMessage(`梯次狀態 ${item.IS_OPEN ? "開啟" : "關閉"} ${pk}`);
    // }

    async function sendLiffMessage(messageText) {
      try {
        await liff.sendMessages([{ type: 'text', text: messageText }]);
      } catch (err) {
        console.error("sendMessages error", err);
        alert("傳送失敗，請確認在 LINE in-app browser 開啟");
      }
    }

    function showHelpView() {
      document.getElementById("studentOverview-view").style.display = "none";
      document.getElementById("help-view").style.display = "block";
    }

    function showIndexView() {
      document.getElementById("help-view").style.display = "none";
      document.getElementById("studentOverview-view").style.display = "block";
    }

    window.onload = initLiff;
  </script>
</body>
</html>